<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>File server</title>
    <link rel="shortcut icon" href="#" />
</head>

<body>

<div>
    <p id="serverinfo"></p>
    <input type="text" id="name">
    <br>
    <button id="start">Start</button>
    <br>
    <br>
    <br>
    <input type="text" id="message">
    <br>
    <button id="send">Send</button>
    <br>
    <div id="messages">

    </div>
</div>

<style>
        body {
            overflow: hidden;
            margin: 0;
        }
        div {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            width: 100vw;
            padding-top: 100px;
        }
        button {
            width: 90px;
            height: 30px;
        }
        #messages {
            margin-top: 0;
            padding: 0;
            overflow-y: scroll;
            max-height: 200px;
        }
        #messages p{
            margin: 10px;
        }
    </style>

<script>

        let serverinfo = document.getElementById('serverinfo');

        let isListening = false;
        if(!isListening) listenForEvents();

        let send = document.getElementById('send')
        let serverButton = document.getElementById('start');
        let isStarted = true;

        serverButton.onclick = e => {
            isStarted = !isStarted
            if(isStarted) {
                serverButton.textContent = "Start"
                Android.stopServer();
            } else {
                serverButton.textContent = "Stop"
                let hostName = document.getElementById('name').value;
                Android.startServer(hostName);
            }
        }

        send.onclick = e => {
            if(!isListening) {
                listenForEvents();
            }
            else {
                let message = document.getElementById('message').value;
                if(message != "") {
                    sendMessage(message);
                }
            }
        }

        async function sendMessage(message){
            const rawResponse = await fetch('http://192.168.0.9:45635/message', {
                method: 'POST',
                headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',

                },
                body: JSON.stringify({message})
            });
            const content = await rawResponse.text();
            console.log(content);
        }



        function addHost(serviceName, hostName, ipaddr) {
            serverinfo.textContent = `${serviceName} ${hostName} ${ipaddr}`;
        }
        function removeHost(serviceName) {
            serverinfo.textContent = "";
        }

        let messages = document.getElementById('messages');

        function listenForEvents() {
            const evtSource = new EventSource('http://192.168.0.9:45635/events');

            evtSource.onmessage = e => {
                let data = JSON.parse(e.data);
                let p = document.createElement('p');
                p.textContent = data.message;
                messages.appendChild(p);
                messages.scrollTop = messages.scrollHeight;
            }

            evtSource.onopen = () => {
                isListening = true;
                console.log("sse open");
                send.textContent = "send";
            }

            evtSource.onerror = () => {
                evtSource.close();
                console.log("sse closed");
                isListening = false;
                send.textContent = "retry";
            }
        }
    </script>


<!-- <form action="upload" method="post" enctype="multipart/form-data">
    Select image to upload:
    <input type="file" name="fileToUpload" id="fileToUpload" multiple>
    <input type="submit" value="Upload Image" name="submit">
</form> -->

</body>
</html>